language: php

env:
  global:
    - secure: "GS2yAVjxQz52WF7iLQIf3aJx4b11CgnDPnMFP3PuH6AnN92ldeVuBsyUJaLQEn7cRLMTd2nUHhUIpGs7fodDW46lA5pqEL/Jx7jcIrVAOZcQAdewnpwCJaksgJnd0S6CkYfUV4Pwd5UHTiTwucY1eTEUb6cd1zQ3VmhKxXYXXmDBv4yGtFKgsTxoWqN1x2u+RoOJiNWsbLm9M/bwVOwFNFXbHLtVwhTQA6vHN7jIEgLUg/rVfMgmX1pwyTfF2cPofV63tc1g2WQAsY7XhcwuzAqDV7faw0k2qUMkHJcac55DagMxblp0Iee1F4Sa9SD2oy4iahfL8q3F7W+JHEnKg2UQgJ+AGTljAmrbus+u8xR44bDb6nK6BFj1PO2yZh4R0/aOAUAFa+l954PJRjQvF39OMNBazksGklRkjzH/lWcBabz+678Rbj75lrstS52sFC4rwniOusP36YMvBitpkByiPGWBDk8azZazgtCPPcSp4RU3CQ/SIYm7GE7ilex0XeBCWvk/trmTXUUGC9dyN720sRMRFugrgjZow1Wrv8dmJZLI5eSfbkGrAdJI9r2RrSjUIIsAmNZ1SLWc8DEeZoxdYHrnYWXasAKI3Llr4RK31F6PcrxvV3gUyFye49ESfkOTIgza30K4g/l5HTJtED2rrLvxW4uCjrkuYrv5b1o="

cache:
  directories:
    - $HOME/.composer/cache
    - $HOME/.php-cs-fixer
    - $HOME/.phpstan

stages:
  - style
  - stan
  - test

jobs:
  include:
    - stage: Style

      php: 7.1

      before_install:
        - source .travis/xdebug.sh
        - xdebug-disable
        - composer validate
        - if [[ -n "$GITHUB_TOKEN" ]]; then composer config github-oauth.github.com $GITHUB_TOKEN; fi

      install:
        - composer install

      before_script:
        - mkdir -p $HOME/.php-cs-fixer

      script:
        - vendor/bin/php-cs-fixer fix --config=.php_cs --diff --dry-run --verbose

    - stage: Stan

      php: 7.1

      before_install:
        - source .travis/xdebug.sh
        - xdebug-disable
        - composer validate
        - if [[ -n "$GITHUB_TOKEN" ]]; then composer config github-oauth.github.com $GITHUB_TOKEN; fi

      install:
        - composer install

      script:
        - vendor/bin/phpstan analyse --configuration=phpstan.neon --level=max src

    - &TEST

      stage: Test

      php: 7.1

      env: WITH_LOWEST=true

      before_install:
        - source .travis/xdebug.sh
        - xdebug-disable
        - composer validate
        - if [[ -n "$GITHUB_TOKEN" ]]; then composer config github-oauth.github.com $GITHUB_TOKEN; fi

      install:
        - composer install

      script:
        - if [[ "$WITH_COVERAGE" == "true" ]]; then xdebug-enable; fi
        - if [[ "$WITH_COVERAGE" == "true" ]]; then vendor/bin/phpunit --configuration=test/Unit/phpunit.xml --coverage-clover=build/logs/clover.xml; else vendor/bin/phpunit --configuration=test/Unit/phpunit.xml; fi
        - if [[ "$WITH_COVERAGE" == "true" ]]; then xdebug-disable; fi
        - vendor/bin/phpunit --configuration=test/Integration/phpunit.xml

      after_success:
        - if [[ "$WITH_COVERAGE" == "true" ]]; then bash <(curl -s https://codecov.io/bash); fi

    - <<: *TEST

      php: 7.1

      env: WITH_LOCKED=true

    - <<: *TEST

      php: 7.1

      env: WITH_HIGHEST=true

    - <<: *TEST

      php: 7.2

      env: WITH_LOWEST=true

    - <<: *TEST

      php: 7.2

      env: WITH_LOCKED=true WITH_COVERAGE=true

    - <<: *TEST

      php: 7.2

      env: WITH_HIGHEST=true

notifications:
  email: false
